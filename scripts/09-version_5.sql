CREATE TABLE CARTORIO.CERTIFICATE (
    SERIALNUMBER NUMBER NOT NULL,
    ALIAS VARCHAR(14) NULL,
    SUBJECT VARCHAR2(255) NULL,
    ISSUER VARCHAR2(255) NULL,
    VALID_FROM TIMESTAMP NULL,
    VALID_TO TIMESTAMP NULL,
    CONTENT VARCHAR2(4000) NULL,
    CREATED_AT TIMESTAMP NULL,
    UPDATED_AT TIMESTAMP DEFAULT NULL,
    CONSTRAINT CTR_CERTIFICATE1_PK PRIMARY KEY (SERIALNUMBER) ENABLE
);


CREATE TABLE CARTORIO.APPLICATION_REGISTRY (
    APPLICATION_ID NUMBER NOT NULL,
    ORIGIN VARCHAR2(500) NOT NULL,
    APPLICATION_CLIENT_ID  VARCHAR2(500) NOT NULL,
    APPLICATION_SECRET VARCHAR(500),
    CREATED_AT TIMESTAMP DEFAULT NULL,
    UPDATED_AT TIMESTAMP DEFAULT NULL, 
    CONSTRAINT CTR_APPLICATION_REGISTRY1_PK PRIMARY KEY (APPLICATION_ID) ENABLE
);

CREATE TABLE CARTORIO.AUTHENTICATION_INFO (
  AUTH_ID NUMBER NOT NULL,
  ALIAS VARCHAR2(500) DEFAULT NULL,
  TOKEN_CONTENT VARCHAR2(500) DEFAULT NULL,
  TOKEN_EXPIRES_AT TIMESTAMP DEFAULT NULL,
  TOKEN_CREATED_AT TIMESTAMP DEFAULT NULL,
  APPLICATION_ID NUMBER NOT NULL,
  SERIALNUMBER NUMBER DEFAULT 0,
  IDENTIFIER_CA VARCHAR(500) DEFAULT NULL,
  IDENTIFIER_EXPIRES_AT TIMESTAMP DEFAULT NULL,
  CSRF_TOKEN VARCHAR2(500) UNIQUE NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT NULL,
  UPDATED_AT TIMESTAMP DEFAULT NULL,
  CONSTRAINT CTR_AUTHENTICATION_INFO1_PK PRIMARY KEY (AUTH_ID) ENABLE,
  CONSTRAINT FK_AUTH_INFO_APPLICATION FOREIGN KEY (APPLICATION_ID) REFERENCES CARTORIO.APPLICATION_REGISTRY (APPLICATION_ID)  
);



INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-899, 'Não foi possível cadastrar a aplicação no motor de assinaturas.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-898, 'Não foi possível assinar. Verifique seu smartphone. Aguardando autorização de aplicativo.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-897, 'Tempo esgotado para conexão com o motor de assinaturas.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-896, 'Não foi encontrada autorização para realização de assinaturas.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-895, 'O motor de assinaturas retornou um erro.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-894, 'A autorização de aplicativo foi revogada ou expirou. Por favor, reinicie o processo para realizar uma nova solicitação de autorização.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-893, 'A autorização de assinatura foi revogada ou expirou. Por favor, reinicie o processo de assinatura para realizar uma nova autorização.');
INSERT INTO CARTORIO.STATUS (STATUS_ID, MESSAGE) VALUES (-2, 'Assinatura Indeterminada');

COMMIT;

-- CRIAÇÃO DE ÍNDICES 
CREATE INDEX CART_CERT_SN_PK ON CARTORIO.CERTIFICATE(SERIALNUMBER)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_CERT_ALIAS ON CARTORIO.CERTIFICATE(ALIAS)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AP_REG_PK ON CARTORIO.APPLICATION_REGISTRY(APPLICATION_ID)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AP_REG_ORIG ON CARTORIO.APPLICATION_REGISTRY(ORIGIN)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AP_REG_ORIG_AP_CL_ID ON CARTORIO.APPLICATION_REGISTRY(ORIGIN, APPLICATION_CLIENT_ID)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AP_REG_AP_CL_ID ON CARTORIO.APPLICATION_REGISTRY(APPLICATION_CLIENT_ID)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AUTH_INFO_PK ON CARTORIO.AUTHENTICATION_INFO(AUTH_ID)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AUTH_INFO_ALIAS ON CARTORIO.AUTHENTICATION_INFO(ALIAS)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AUTH_INFO_SN ON CARTORIO.AUTHENTICATION_INFO(SERIALNUMBER)
   TABLESPACE mvcartorio_I
/

CREATE INDEX CART_AUTH_INFO_CSRF_TOKEN ON CARTORIO.AUTHENTICATION_INFO(CSRF_TOKEN)
   TABLESPACE mvcartorio_I
/

INSERT INTO CARTORIO.STATUS VALUES (-25, 'Origem inválida');
INSERT INTO CARTORIO.STATUS VALUES (-26, 'Documento não assinado pelo cliente');
INSERT INTO CARTORIO.STATUS VALUES (-27, 'Prestador não encontrado para o alias informado');
INSERT INTO CARTORIO.STATUS VALUES (-28, 'Email do prestador não encontrado');

ALTER TABLE cartorio.document ADD SECRET_CODE_QR VARCHAR(64) DEFAULT NULL;

CREATE TABLE CARTORIO.CREDENTIAL_E_CNPJ(
    CREDENTIAL_ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    COMPANY_CODE VARCHAR2(10) NOT NULL,
    CNPJ VARCHAR2(14) NOT NULL,
    PASSWORD VARCHAR2(20) NOT NULL,
    CREATION_AT TIMESTAMP  NOT NULL,
    UPDATE_AT TIMESTAMP NOT NULL,
    CONSTRAINT CTR_CREDENTIAL_E_CNPJ_PK PRIMARY KEY (CREDENTIAL_ID) ENABLE
);

CREATE INDEX CART_CREDENTIAL_E_CNPJ_PK ON CARTORIO.CREDENTIAL_E_CNPJ(CREDENTIAL_ID)
   TABLESPACE mvcartorio_I
/

ALTER TABLE CARTORIO.SIGNATURE DROP CONSTRAINT CNT_SIGNATURE_FK;
ALTER TABLE CARTORIO.SIGNATURE ADD CONSTRAINT CNT_SIGNATURE_FK FOREIGN KEY(DOCUMENT_ID) REFERENCES CARTORIO.DOCUMENT(DOCUMENT_ID) ON DELETE CASCADE;

ALTER TABLE cartorio.document DROP COLUMN PDF_PACIENTE; 
ALTER TABLE cartorio.document DROP COLUMN P7S_PACIENTE;
ALTER TABLE cartorio.document DROP COLUMN ID_CLIENT;

INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-10, 'Erro ao tentar estabelecer conexão com o banco de dados GreenS+');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-11, 'Falha de comunição com o motor de assinaturas');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-12, 'Conexão interrompida antes da comunicação finalizar');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-13, 'Falha durante a comunicação SOAP com o motor de assinaturas, retorno sem detalhes específicos');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-14, 'Falha de validação ICPM com o motor de assinaturas, retorno sem detalhes específicos');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-15, 'Erro ao tentar se comunicar com o motor de assinaturas');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-16, 'Falha durante a comunicação SOAP com o motor de assinaturas, usuário não especificado para a ação solicitada');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-17, 'Falha durante a comunicação SOAP com o motor de assinaturas, transação não autorizada');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-18, 'Falha durante a comunicação SOAP com o motor de assinaturas, nenhum documento armazenamento contém o mesmo hash');
INSERT INTO CARTORIO.STATUS(STATUS_ID, MESSAGE)
values(-19, 'Falha de validação ICPM com o motor de assinaturas, certillion retornou erro');

INSERT INTO CARTORIO.STATUS ("STATUS_ID", "MESSAGE") 
VALUES (-32, 'A transação não foi autorizada. Senha incorreta para o usuário');

CREATE TABLE CARTORIO.AUDITORIA (
    ID NUMBER NOT NULL,
    CONTRACT VARCHAR2(2000) NULL,
    ALIAS VARCHAR2(500) NULL,
    TIPO_AUDITORIA VARCHAR2(50) NOT NULL,
    CONTENT BLOB NULL,
    DATA_HORA TIMESTAMP NULL,
    CONSTRAINT CTR_AUDITORIA_PK PRIMARY KEY (ID) ENABLE
);

COMMIT;
